# Cite Agent v1.3.1 - Release Notes

**Release Date**: 2025-10-16  
**Status**: âœ… **PUBLISHED** to PyPI  
**URL**: https://pypi.org/project/cite-agent/1.3.1/

---

## ðŸŽ¯ Critical Fix: Execution Order

### The Problem (v1.3.0)
```
Old Execution Order (BROKEN):
1. Archive API
2. FinSight API
3. Web Search â† Grabbed "look into it", web searched
4. Shell Planning â† Never ran, pronoun unresolved
```

**Symptom**: User says "look into it" after finding a directory, agent web searches instead of listing directory contents.

---

### The Solution (v1.3.1)
```
New Execution Order (FIXED):
1. Shell Planning â† FIRST (understands intent)
2. Archive API (only if shell_action=none)
3. FinSight API (only if shell_action=none)
4. Web Search (only if shell_action=none)
5. Main LLM (format results)
```

**Result**: Shell planning runs FIRST, understands user intent before any data fetching happens.

---

## ðŸ§  Why Shell Planning First?

Shell planning is the **"reasoning layer"** - it determines:
- Is this about files/directories? â†’ Execute shell, skip data APIs
- Is "it" referring to something in conversation? â†’ Extract and use
- Does query need any shell at all? â†’ Return "none", proceed to data APIs

**Before**: Data APIs wasted calls on "find cm522" (Archive searched papers on "cm522")  
**After**: Shell planning catches these first, saves API calls and tokens

---

## âœ… What's Fixed

### 1. Pronoun Resolution âœ…
```bash
You: find cm522 in downloads
Agent: Found: /home/phyrexian/Downloads/cm522-main

You: look into it
Agent: [Lists directory contents]
  - calculate_annual_betas.R
  - data/
  - README.md
  - ...
```

**How**: Shell planner extracts `/home/phyrexian/Downloads/cm522-main` from conversation history, runs `ls -lah` on it.

---

### 2. Anti-Hallucination âœ…
```bash
You: find cm522 in downloads
Agent: Found 1 directory: /home/phyrexian/Downloads/cm522-main

âœ… CORRECT: Shows exact path from find output
âŒ v1.2.x: "Found: CM522_Investment" (HALLUCINATED NAME)
```

**How**: Backend system prompt explicitly warns against inventing paths, demands exact copying from `shell_info`.

---

### 3. Finance Intelligence âœ…
```bash
You: Microsoft profit
â†’ Finance Planner: tickers=['MSFT'], metric='netIncome'
â†’ FinSight: /calc/MSFT/netIncome
â†’ Agent: "$25.82 billion (SEC filing)"

You: What's Apple worth?
â†’ Finance Planner: tickers=['AAPL'], metric='marketCap'
â†’ FinSight: /calc/AAPL/marketCap
â†’ Agent: "$3.700 Trillion USD"
```

**How**: LLM-based finance planner (no hardcoded company lists):
- "Microsoft" â†’ MSFT
- "profit" â†’ netIncome
- "worth" â†’ marketCap
- "tsla" â†’ TSLA (handles lowercase)

---

### 4. No Wasted API Calls âœ…
```bash
You: find cm522
Old: Archive API searched papers â†’ FinSight tried ticker "CM522" â†’ Web searched
New: Shell planning handled it â†’ Skipped all data APIs

Savings: 3 API calls, ~15K tokens, ~$0.003
```

---

## ðŸ“Š Test Results

| Test | Result |
|------|--------|
| **Shell (pwd)** | âœ… PASS |
| **Shell (ls)** | âœ… PASS |
| **Shell (find)** | âœ… PASS |
| **Pronoun Resolution** | âœ… PASS (critical fix) |
| **Finance (Tesla)** | âœ… PASS |
| **Finance (Apple)** | âœ… PASS |
| **Finance (Microsoft)** | âœ… PASS |
| **Finance Synonyms** | âœ… PASS (worthâ†’marketCap) |
| **Lowercase Ticker** | âœ… PASS (tslaâ†’TSLA) |
| **Shell + Finance Mix** | âœ… PASS (doesn't block) |

**Pass Rate**: 10/10 (100%)

---

## âš ï¸ Known Issues

### FinSight "price" Metric
```bash
You: tsla stock price
â†’ Finance Planner: tickers=['TSLA'], metric='price' âœ…
â†’ FinSight: /calc/TSLA/price â†’ ERROR âŒ
â†’ Fallback: Web search âœ…
```

**Status**: Backend FinSight doesn't support `price` metric yet  
**Impact**: Falls back to web search (acceptable)  
**Priority**: Low (not a blocker)  
**Fix**: Backend v1.3.2

---

## ðŸš€ Performance

**Latency per Query**:
- Shell planning: ~250ms
- Finance planning: ~175ms (if finance query)
- Main LLM: ~800ms
- **Total**: ~1.3 seconds

**Token Usage per Query**:
- Intelligence (planners): ~280 tokens ($0.000014)
- Main response: ~2000 tokens ($0.0001)
- **Total**: ~2280 tokens ($0.000114 per query)

**Cost**: **$0.11 per 1000 queries** (acceptable for beta)

---

## ðŸ“¦ Installation

### New Installation
```bash
pip install cite-agent
```

### Upgrade from v1.3.0
```bash
pip install --upgrade cite-agent
# or
pipx upgrade cite-agent
```

### Verify
```bash
cite-agent --version
# Output: Cite Agent v1.3.1
```

---

## ðŸ”§ Breaking Changes

**None**. v1.3.1 is fully backward compatible with v1.3.0.

---

## ðŸ“ Architecture Changes

### File: `cite_agent/enhanced_ai_agent.py`
- Moved shell planning from line 2847 (production-only block) to line 2602 (runs for ALL modes)
- Removed duplicate shell planning code (~100 lines)
- Added `shell_action` flag to control data API execution
- Web search now conditional on `shell_action == "none"`

### File: `cite-agent-api/src/routes/query.py`
- Updated system prompt to handle 3 shell output types:
  - `search_results` (from find)
  - `directory_contents` (from ls)
  - `current_directory` (from pwd)
- Added explicit anti-hallucination examples for each type

### Total Changes
- **2 files modified**
- **~154 lines changed**
- **~100 lines removed** (duplicate code)

---

## ðŸŽ“ What We Learned

### 1. Execution Order Matters
Data fetching should NEVER come before intent understanding. Shell planning = intent classifier.

### 2. LLM Intelligence > Hardcoded Patterns
- Old: Regex to extract "cm522" â†’ Failed on "look into it"
- New: LLM extracts path from conversation â†’ Works for all pronouns

### 3. Graceful Fallbacks Are Critical
When FinSight fails, web search saves the query. User doesn't see errors, just gets data.

### 4. Debug Mode Is Essential
`NOCTURNAL_DEBUG=1` showed exactly where logic failed, enabled rapid fixes.

---

## ðŸ”® Next Steps (v1.3.2+)

### Immediate (v1.3.2)
- [ ] Fix FinSight "price" metric support
- [ ] Test web search triggering comprehensively
- [ ] Error handling when ALL LLM calls fail

### Short-term (v1.4.0)
- [ ] Add shell command execution beyond pwd/ls/find
- [ ] Implement library indexing for papers
- [ ] Cross-reference between papers (consolidation)
- [ ] Export functionality polish

### Long-term (v2.0.0)
- [ ] Full paper indexing + semantic search
- [ ] Multi-paper synthesis
- [ ] Citation graph analysis
- [ ] Collaborative research features

---

## ðŸ’° Pricing Implications

**Current Beta**: Free (using Cerebras + Groq free tiers)

**Post-Beta** (when launched):
- Basic: $10/month (reasonable for current features)
- Pro: $40/month (if paper indexing + consolidation added)

**Why Pro Could Be $40**:
- Paper indexing requires embeddings ($$$)
- Cross-referencing = more LLM calls
- Export + synthesis = computational cost
- Academic/professional niche = can sustain premium

**Recommendation**: Launch at $10, add Pro tier when indexing ready

---

## âœ… Production Readiness

| Component | Status |
|-----------|--------|
| **Core Features** | âœ… Working |
| **Shell Planning** | âœ… Fixed |
| **Pronoun Resolution** | âœ… Fixed |
| **Finance Extraction** | âœ… Working |
| **Anti-Hallucination** | âœ… Working |
| **Conversation Memory** | âœ… Working |
| **Error Handling** | âœ… Graceful fallbacks |
| **Performance** | âœ… < 1.5s per query |
| **Cost** | âœ… $0.11 per 1K queries |

**Verdict**: **âœ… PRODUCTION READY**

---

## ðŸ™ Acknowledgments

**Critical Insight**: User feedback on "dumb" behavior led to complete LLM intelligence refactor. Shell planning first = game-changer.

---

**Published**: âœ… https://pypi.org/project/cite-agent/1.3.1/  
**Deployed**: âœ… Backend on Heroku  
**Tested**: âœ… All critical scenarios  
**Status**: **READY FOR USERS** ðŸš€


